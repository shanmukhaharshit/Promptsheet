<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PromptSheet</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styles for table */
        .data-table-container {
            max-height: 300px; /* Limit height for scrollability */
            overflow-y: auto;
            border: 1px solid #e2e8f0; /* gray-200 */
            border-radius: 0.5rem; /* rounded-lg */
            background-color: #f8fafc; /* gray-50 */
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem; /* text-sm */
        }
        .data-table th, .data-table td {
            padding: 0.75rem; /* p-3 */
            border: 1px solid #e2e8f0; /* gray-200 */
            text-align: left;
        }
        .data-table th {
            background-color: #edf2f7; /* gray-100 */
            font-weight: 600; /* font-semibold */
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .data-table tbody tr:nth-child(even) {
            background-color: #f7fafc; /* gray-50 */
        }
    </style>
    <!-- Firebase SDKs - MUST be loaded before your React app script -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"></script>
    <!-- XLSX library for Excel file parsing - MUST be loaded before your React app script -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import React, { useState, useEffect } from 'https://esm.sh/react@18.2.0';
        import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';

        // IMPORTANT: The xlsx.full.min.js library and Firebase SDKs are loaded via script tags above.
        // They are available globally via `window.XLSX` and `window.firebase`.

        function App() {
          const [excelData, setExcelData] = useState(null);
          const [fileName, setFileName] = useState('');
          const [userQuery, setUserQuery] = useState('');
          const [response, setResponse] = useState(''); // This holds the AI's textual insight (for display)
          const [isLoading, setIsLoading] = useState(false);
          const [error, setError] = useState('');
          const [db, setDb] = useState(null);
          const [auth, setAuth] = useState(null);
          const [userId, setUserId] = useState(null);
          const [isAuthReady, setIsAuthReady] = useState(false);
          const [parsedTableData, setParsedTableData] = useState(null); // New state for parsed tabular data

          useEffect(() => {
            const initializeFirebase = async () => {
              if (!window.firebase || !window.firebase.initializeApp || !window.firebase.firestore || !window.firebase.auth) {
                console.warn("Firebase SDK not loaded. Ensure Firebase CDN scripts are included.");
                // Removed: setError("Firebase SDK not loaded. Please check the environment setup."); // This line was explicitly removed as per previous request
                return;
              }

              try {
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
                if (!firebaseConfig) {
                  console.error("Firebase config not found. Cannot initialize Firebase.");
                  setError("Application error: Firebase configuration missing.");
                  return;
                }

                const app = window.firebase.initializeApp(firebaseConfig);
                const firestoreDb = window.firebase.firestore.getFirestore(app);
                const firebaseAuth = window.firebase.auth.getAuth(app);

                setDb(firestoreDb);
                setAuth(firebaseAuth);

                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                if (initialAuthToken) {
                  await window.firebase.auth.signInWithCustomToken(firebaseAuth, initialAuthToken);
                } else {
                  await window.firebase.auth.signInAnonymously(firebaseAuth);
                }

                const unsubscribe = window.firebase.auth.onAuthStateChanged(firebaseAuth, (user) => {
                  if (user) {
                    setUserId(user.uid);
                    console.log("Firebase user ID:", user.uid);
                  } else {
                    const newUserId = crypto.randomUUID();
                    setUserId(newUserId);
                    console.log("No Firebase user, generated random ID:", newUserId);
                  }
                  setIsAuthReady(true);
                });

                return () => unsubscribe();

              } catch (err) {
                console.error("Failed to initialize Firebase or authenticate:", err);
                setError(`Failed to initialize application: ${err.message}`);
                setIsAuthReady(true);
              }
            };

            initializeFirebase();
          }, []);

          const saveExcelData = async () => {
            if (!db || !userId || !isAuthReady) {
              console.warn("Firestore, user ID, or auth not ready. Cannot save data.");
              return;
            }
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            try {
              const userDocRef = window.firebase.firestore.doc(db, `artifacts/${appId}/users/${userId}/app_state/excel_analyzer`);
              await window.firebase.firestore.setDoc(userDocRef, {
                lastFileName: fileName,
                lastProcessedAt: window.firebase.firestore.Timestamp.now(),
              }, { merge: true });
              console.log("App state saved to Firestore.");
            } catch (e) {
              console.error("Error saving app state to Firestore:", e);
            }
          };

          const handleFileUpload = (event) => {
            const file = event.target.files[0];
            if (file) {
              setFileName(file.name);
              setError('');
              setResponse(''); // Clear previous AI response on new file upload
              setParsedTableData(null); // Clear previous parsed table data
              const reader = new FileReader();

              reader.onload = (e) => {
                try {
                  if (!window.XLSX) {
                    setError("Excel parsing library (XLSX) not loaded. Please refresh or check console for errors.");
                    console.error("window.XLSX is undefined. xlsx.full.min.js might not be loaded.");
                    setExcelData(null);
                    return;
                  }

                  const data = new Uint8Array(e.target.result);
                  const workbook = window.XLSX.read(data, { type: 'array' });
                  const sheetName = workbook.SheetNames[0];
                  const worksheet = workbook.Sheets[sheetName];
                  const json = window.XLSX.utils.sheet_to_json(worksheet);
                  setExcelData(json);
                  console.log("Excel data parsed:", json);
                  saveExcelData();
                } catch (err) {
                  console.error("Error reading Excel file:", err);
                  setError("Failed to read Excel file. Please ensure it's a valid .xlsx or .xls file. Details: " + err.message);
                  setExcelData(null);
                }
              };
              reader.readAsArrayBuffer(file);
            }
          };

          const handleQuerySubmit = async () => {
            if (!excelData) {
              setError("Please upload an Excel file first.");
              return;
            }
            if (!userQuery.trim()) {
              setError("Please enter a query.");
              return;
            }

            setIsLoading(true);
            setError('');
            setResponse('');
            setParsedTableData(null); // Clear previous parsed table data

            // Prompt for analyzing uploaded Excel data
            const prompt = `You are an intelligent data analysis assistant. A user has uploaded an Excel file, and its data is provided below in JSON format. Your task is to analyze the provided data based on the user's query and return the requested information.

**IMPORTANT:** If the query asks for data that can be presented in a table (e.g., a list of items, specific records, or a comparison), please provide the response in **Comma-Separated Values (CSV) format**, including a header row. **Crucially, provide ONLY the CSV data and nothing else (no markdown code blocks, no introductory or concluding sentences).** Each row should be on a new line.

**Example of desired CSV output for a query like "List students and their roll numbers":**
"Student Name","Roll Number"
"GADILA BHARATH RAO AILENI","2211CS010008"
"MANISH REDDY ALTI","2211CS010018"
"RAHUL RAJ A","2211CS010029"

If the query asks for a single value, a general summary, or information that cannot be neatly represented as a table, provide your response in clear, concise natural language. **In this case, do not include any CSV formatting.**

If the information cannot be found or inferred from the provided data, please state that you cannot find it in natural language.

Excel Data (JSON, first 100 rows if more):
${JSON.stringify(excelData.slice(0, 100))}

User Query:
${userQuery}

Please provide the answer based *only* on the provided Excel data, in the specified format.`;

            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });
            const payload = { contents: chatHistory };
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            try {
              const apiResponse = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
              });

              if (!apiResponse.ok) {
                const errorData = await apiResponse.json();
                throw new Error(`API error: ${apiResponse.status} ${apiResponse.statusText} - ${errorData.error.message}`);
              }

              const result = await apiResponse.json();
              if (result.candidates && result.candidates.length > 0 &&
                result.candidates[0].content && result.candidates[0].content.parts &&
                result.candidates[0].content.parts.length > 0) {
                const text = result.candidates[0].content.parts[0].text;
                setResponse(text); // Set the AI's raw text response for display

                // Attempt to parse as CSV for tabular display
                try {
                    // Remove markdown code block wrappers if they exist
                    const cleanedText = text.replace(/^```csv\s*\n|\n\s*```$/g, '').trim();

                    // Basic check for CSV: contains commas and newlines (if multi-line)
                    const isPotentiallyCsv = cleanedText.includes(',') && (cleanedText.includes('\n') || cleanedText.startsWith('"'));

                    if (isPotentiallyCsv) {
                        const workbookFromCsv = window.XLSX.read(cleanedText, { type: 'string', raw: true });
                        const firstSheetName = workbookFromCsv.SheetNames[0];
                        const csvJson = window.XLSX.utils.sheet_to_json(workbookFromCsv.Sheets[firstSheetName]);
                        if (csvJson.length > 0) {
                            setParsedTableData(csvJson);
                        } else {
                            setParsedTableData(null); // CSV was empty or not truly tabular
                        }
                    } else {
                        setParsedTableData(null); // Not CSV-like
                    }
                } catch (parseError) {
                    console.warn("Could not parse AI response as CSV for UI display:", parseError);
                    setParsedTableData(null);
                }

              } else {
                setResponse("No response from the AI. Please try a different query.");
                setParsedTableData(null);
              }
            } catch (err) {
              console.error("Error calling Gemini API:", err);
              setError(`Failed to get a response: ${err.message}. Please try again.`);
              setResponse("An error occurred while processing your request.");
              setParsedTableData(null);
            } finally {
              setIsLoading(false);
            }
          };

          // Function to handle downloading the AI's insight as an Excel file
          const handleDownloadExcel = () => {
            if (!response || response.trim() === '') {
              setError("No AI insight to download. Please ask a question first.");
              return;
            }

            try {
              if (!window.XLSX) {
                setError("Excel parsing library (XLSX) not loaded. Cannot download.");
                console.error("window.XLSX is undefined. xlsx.full.min.js might not be loaded.");
                return;
              }

              let ws;
              let defaultFileName = "ai_insight.xlsx";

              // Remove markdown code block wrappers from the response before parsing for download
              const cleanedResponseForDownload = response.replace(/^```csv\s*\n|\n\s*```$/g, '').trim();

              // Attempt to detect if the response is CSV-like for download
              const lines = cleanedResponseForDownload.trim().split('\n');
              const hasMultipleLines = lines.length > 1;
              const headerHasCommas = lines[0].includes(',');
              let allLinesConsistent = true;
              let expectedColumnCount = 0;

              if (hasMultipleLines && headerHasCommas) {
                  expectedColumnCount = lines[0].split(',').length;
                  for (let i = 1; i < lines.length; i++) {
                      if (lines[i].trim() !== '' && lines[i].split(',').length !== expectedColumnCount) {
                          allLinesConsistent = false;
                          break;
                      }
                  }
              } else if (lines.length === 1 && lines[0].includes(',')) {
                  expectedColumnCount = lines[0].split(',').length;
              } else {
                  allLinesConsistent = false;
              }

              const isCsvLike = hasMultipleLines && headerHasCommas && allLinesConsistent;

              if (isCsvLike) {
                // If it looks like CSV, parse it using XLSX.read
                const workbookFromCsv = window.XLSX.read(cleanedResponseForDownload, { type: 'string', raw: true });
                ws = workbookFromCsv.Sheets[workbookFromCsv.SheetNames[0]];
                defaultFileName = "ai_tabular_insight.xlsx";
                // Auto-fit columns based on content (simple heuristic)
                const data = window.XLSX.utils.sheet_to_json(ws, { header: 1 });
                if (data.length > 0) {
                    const header = Object.keys(data[0]); // Get headers from the first row of parsed JSON
                    ws['!cols'] = header.map((h, colIdx) => ({
                        wch: Math.max(h.length, ...data.map(row => String(row[h] || '').length)) + 2
                    }));
                }
              } else {
                // Fallback to single cell if not CSV-like
                ws = window.XLSX.utils.aoa_to_sheet([[response]]); // Use original 'response' for non-CSV fallback
                ws['!cols'] = [{ wch: 100 }]; // Set width for text
              }

              const wb = window.XLSX.utils.book_new();
              window.XLSX.utils.book_append_sheet(wb, ws, "AI_Insight");
              window.XLSX.writeFile(wb, defaultFileName);
            } catch (err) {
              console.error("Error downloading AI insight to Excel:", err);
              setError("Failed to download AI insight to Excel. Details: " + err.message);
            }
          };

          // Function to open Google Sheets (removed from UI)
          const handleOpenGoogleSheets = () => {
            window.open("https://docs.google.com/spreadsheets/", "_blank");
          };

          return React.createElement(
            'div',
            { className: 'min-h-screen bg-yellow-400 flex items-center justify-center p-4' }, // Solid vibrant yellow background
            React.createElement(
              'div',
              { className: 'bg-white p-8 rounded-xl shadow-2xl w-full max-w-3xl border border-gray-300 transform hover:scale-[1.01] transition-transform duration-300 ease-in-out' }, // White card with subtle border
              React.createElement(
                'h1',
                { className: 'text-4xl font-extrabold text-center text-gray-900 mb-8 tracking-tight' }, // Dark text for heading
                'PromptSheet - Your Data Insight'
              ),
              userId && React.createElement(
                'div',
                { className: 'mb-4 text-sm text-gray-700 text-center' }, // Darker gray for user ID text
                'Your User ID: ',
                React.createElement(
                  'span',
                  { className: 'font-mono bg-gray-200 px-2 py-1 rounded-md' }, // Lighter gray for user ID background
                  userId
                )
              ),
              React.createElement(
                'div',
                { className: 'mb-6 border-b pb-6 border-gray-200' }, // Lighter border
                React.createElement(
                  'label',
                  { htmlFor: 'file-upload', className: 'block text-lg font-semibold text-gray-800 mb-3' }, // Darker gray for label
                  '1. Upload Your Excel File'
                ),
                React.createElement('input', {
                  id: 'file-upload',
                  type: 'file',
                  accept: '.xlsx, .xls',
                  onChange: handleFileUpload,
                  className: 'block w-full text-sm text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-gray-800 file:text-yellow-400 hover:file:bg-gray-900 cursor-pointer'
                }),
                fileName && React.createElement(
                  'p',
                  { className: 'mt-2 text-sm text-gray-700' }, // Darker gray for file info
                  'File selected: ',
                  React.createElement(
                    'span',
                    { className: 'font-medium text-gray-900' }, // Even darker for filename
                    fileName
                  )
                ),
                excelData && React.createElement(
                  'p',
                  { className: 'mt-2 text-sm text-green-600' },
                  'File successfully loaded! Ready to analyze.'
                )
              ),
              React.createElement(
                'div',
                { className: 'mb-6 border-b pb-6 border-gray-200' }, // Lighter border
                React.createElement(
                  'label',
                  { htmlFor: 'user-query', className: 'block text-lg font-semibold text-gray-800 mb-3' }, // Darker gray for label
                  '2. Ask Your Question'
                ),
                React.createElement('textarea', {
                  id: 'user-query',
                  className: 'w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent outline-none transition duration-200 resize-y min-h-[80px]', // Yellow focus ring
                  placeholder: "E.g., 'Show me the names of students who did not submit their assignments.' or 'What is the average score?'",
                  value: userQuery,
                  onChange: (e) => setUserQuery(e.target.value),
                  rows: '3'
                }),
                React.createElement(
                  'button',
                  {
                    onClick: handleQuerySubmit,
                    disabled: isLoading || !excelData,
                    className: 'mt-4 w-full bg-gray-800 text-yellow-400 py-3 px-6 rounded-lg font-bold text-lg hover:bg-gray-900 transition duration-300 ease-in-out shadow-md hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center space-x-2' // Dark button with yellow text
                  },
                  isLoading ? React.createElement(
                    React.Fragment,
                    null,
                    React.createElement(
                      'svg',
                      { className: 'animate-spin h-5 w-5 text-yellow-400', xmlns: 'http://www.w3.org/2000/svg', fill: 'none', viewBox: '0 0 24 24' },
                      React.createElement('circle', { className: 'opacity-25', cx: '12', cy: '12', r: '10', stroke: 'currentColor', strokeWidth: '4' }),
                      React.createElement('path', { className: 'opacity-75', fill: 'currentColor', d: 'M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z' })
                    ),
                    React.createElement(
                      'span',
                      null,
                      'Analyzing Data...'
                    )
                  ) : React.createElement(
                    'span',
                    null,
                    'Get Data Insight'
                  )
                )
              ),
              React.createElement(
                'div',
                { className: 'mb-6 border-b pb-6 border-gray-200' }, // Lighter border
                React.createElement(
                  'h2',
                  { className: 'text-lg font-semibold text-gray-800 mb-3' }, // Darker gray for label
                  '3. Actions'
                ),
                React.createElement(
                  'button',
                  {
                    onClick: handleDownloadExcel,
                    disabled: !response,
                    className: 'w-full bg-gray-700 text-yellow-300 py-3 px-6 rounded-lg font-bold text-lg hover:bg-gray-800 transition duration-300 ease-in-out shadow-md hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center space-x-2 mb-3' // Darker button for download
                  },
                  React.createElement(
                    'svg',
                    { className: 'h-5 w-5', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24', xmlns: 'http://www.w3.org/2000/svg' },
                    React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: '2', d: 'M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4' })
                  ),
                  React.createElement(
                    'span',
                    null,
                    'Download AI Insight (.xlsx)'
                  )
                )
              ),
              // Removed the "Open Google Sheets" button
              React.createElement(
                'div',
                { className: 'mt-8' }, // Added margin-top to separate from actions
                React.createElement(
                  'h2',
                  { className: 'text-2xl font-bold text-gray-900 mb-4' }, // Larger, bolder heading for overall output
                  '4. Output Data'
                ),
                error && React.createElement(
                  'div',
                  { className: 'bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-4', role: 'alert' },
                  React.createElement(
                    'strong',
                    { className: 'font-bold' },
                    'Error:'
                  ),
                  React.createElement(
                    'span',
                    { className: 'block sm:inline ml-2' },
                    error
                  )
                ),
                React.createElement(
                  'h3',
                  { className: 'text-lg font-semibold text-gray-800 mb-3 mt-6' }, // Darker gray for label
                  '4.1. AI Response (Raw Text)' // Renamed and renumbered
                ),
                React.createElement(
                  'div',
                  { className: 'bg-gray-50 p-4 rounded-lg border border-gray-200 min-h-[120px] max-h-[400px] overflow-auto text-gray-800 leading-relaxed whitespace-pre-wrap' },
                  response || (excelData ? "Your answer will appear here after you ask a question." : "Upload an Excel file to begin.")
                ),
                React.createElement(
                  'div',
                  { className: 'mt-6' },
                  React.createElement(
                    'h3',
                    { className: 'text-lg font-semibold text-gray-800 mb-3' },
                    '4.2. Tabular Data (In-App View)' // Renamed and renumbered
                  ),
                  parsedTableData && parsedTableData.length > 0 ? React.createElement(
                    'div',
                    { className: 'data-table-container' },
                    React.createElement(
                      'table',
                      { className: 'data-table' },
                      React.createElement(
                        'thead',
                        null,
                        React.createElement(
                          'tr',
                          null,
                          Object.keys(parsedTableData[0]).map((key) =>
                            React.createElement('th', { key: key }, key)
                          )
                        )
                      ),
                      React.createElement(
                        'tbody',
                        null,
                        parsedTableData.map((row, rowIndex) =>
                          React.createElement(
                            'tr',
                            { key: rowIndex },
                            Object.values(row).map((value, colIndex) =>
                              React.createElement('td', { key: colIndex }, String(value))
                            )
                          )
                        )
                      )
                    )
                  ) : React.createElement(
                    'div',
                    { className: 'bg-gray-50 p-4 rounded-lg border border-gray-200 min-h-[80px] text-gray-600 flex items-center justify-center' },
                    'Tabular data will appear here if the AI response is in CSV format.'
                  )
                )
              )
            )
          );
        }

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(React.createElement(App));
    </script>
</body>
</html>
